# This workflow will:
# 1) Build a Docker image from the latest commit to the main branch in the repository and tag it with 'latest'
# 2) Push the Docker image to DockerHub repository by the same name as the GitHub repository

name: Build Image and Push to DockerHub

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version (Must Match Git Tag. Leave blank for Latest)
        required: false
        type: string

  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
        
# env:
#   GIT_TAG: ${{ inputs.version }}

jobs:

  build-push:

    runs-on: ubuntu-latest

    steps:
      # This step is run when the tag is release-XXX
      - name: Sets GIT_TAG to specified version
        run: |
          echo "GIT_TAG=${{ inputs.version }}" >> $GITHUB_ENV
        if: ${{ inputs.version != '' }}

      # # This step is run when the tag is staging-XXX
      # - name: Sets env vars for staging
      #   run: |
      #     echo "DOCKER_IMAGE_NAME=my.docker.repo/awesome-image:staging" >> $GITHUB_ENV
      #   if: ${{ inputs.version == '' }}

      - name: "Say Hello Mona it's Monday"
        run: echo "GIT_TAG is $GIT_TAG"

        
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}
      
      # Start by logging into DockerHub account
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          
      # QEMU is used by the docker/build-push-action action
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      # Buildx is used by the docker/build-push-action action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # # If 'Version' was specified, this will use the Docker metadata action to create a docker tag containing the git commit hash (sha)
      # - name: Docker meta
      #   id: meta
      #   uses: docker/metadata-action@v5.6.1
      #   with:
      #     images: |
      #       ${{ vars.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
      #     tags: |
      #       type=sha
      
      # If 'Version' was specified, this action will build the docker image from the commit that's tagged with the specified version
      # and push the image to DockerHug with the specified version as the tag
      - name: Build and Push Specific Version
        if: ${{ inputs.version != '' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${{ inputs.version }}
          #tags: ${{ steps.meta.outputs.tags }}

       # If 'Version' was NOT specified, this action will build the docker image from the latest commit and push it to DockerHub using the 'Latest' tag
      - name: Build and Push Latest
        if: ${{ inputs.version == '' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
